<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">Place Order</h2>
    <form id="orderForm">
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="orderDate" class="form-label">Date</label>
                <input type="date" id="orderDate" class="form-control">
            </div>
            <div class="col-md-4">
                <label for="orderId" class="form-label">Order ID</label>
                <input type="text" id="orderId" class="form-control">
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <label for="itemCode" class="form-label">Choose Item Code</label>
                <select id="itemCode" class="form-select">
                    <option value="">Select Item</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="itemName" class="form-label">Item Name</label>
                <input type="text" id="itemName" class="form-control" disabled>
            </div>
            <div class="col-md-4">
                <label for="availableQty" class="form-label">Available Quantity</label>
                <input type="number" id="availableQty" class="form-control" disabled>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <label for="unitPrice" class="form-label">Unit Price</label>
                <input type="text" id="unitPrice" class="form-control" disabled>
            </div>
            <div class="col-md-4">
                <label for="phone" class="form-label">Choose Customer Phone</label>
                <select id="phone" class="form-select">
                    <option value="">Select Phone</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="customerName" class="form-label">Customer Name</label>
                <input type="text" id="customerName" class="form-control" disabled>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <label for="quantity" class="form-label">Quantity</label>
                <input type="number" id="quantity" class="form-control">
            </div>
            <div class="col-md-4">
                <label for="total" class="form-label">Total</label>
                <input type="text" id="total" class="form-control" disabled>
            </div>
        </div>

        <button type="button" class="btn btn-success" id="addToCart">Add to Cart</button>
        <button type="reset" class="btn btn-warning">Clear</button>
        <button type="button" class="btn btn-primary" id="placeOrder">Place Order</button>
    </form>

    <h3 class="mt-5">Cart</h3>
    <table class="table table-bordered mt-3">
        <thead>
        <tr>
            <th>Item Code</th>
            <th>Item Name</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="cartTableBody">
        <!-- Cart items will be added here dynamically -->
        </tbody>
    </table>
</div>
<script src="../js/jquery.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    loadItemCodes();
    loadCustomerPhones();

    function loadItemCodes() {
        $.ajax({
            url: "http://localhost:8080/api/v1/item/getItemCodes",
            method: "GET",
            dataType: "json",
            success: (resp) => {
                console.log("API Response:", resp); // Debugging

                // Check if `resp.data` is an array
                if (!Array.isArray(resp.data)) {
                    console.error("Error: Response data is not an array", resp);
                    return;
                }

                let itemDropdown = $("#itemCode");
                itemDropdown.empty().append('<option value="">Select Item</option>');

                // Loop through `resp.data`
                resp.data.forEach(code => {
                    itemDropdown.append(`<option value="${code}">${code}</option>`);
                });
            },
            error: (err) => {
                console.error("Error loading item codes:", err);
            }
        });
    }

    function loadCustomerPhones() {
        $.ajax({
            url: "http://localhost:8080/api/v1/customer/getCustomerPhone",
            method: "GET",
            dataType: "json",
            success: function (resp) {
                console.log("API Response:", resp); // Debugging output

                // Ensure `resp.data` exists and is an array
                if (!resp.data || !Array.isArray(resp.data)) {
                    console.error("Error: Response data is not an array", resp);
                    return;
                }

                let phoneSelect = document.getElementById("phone");
                phoneSelect.innerHTML = '<option value="">Select Phone</option>'; // Clear previous options

                // Iterate over resp.data instead of resp
                resp.data.forEach(phone => {
                    let option = document.createElement("option");
                    option.value = phone;
                    option.textContent = phone;
                    phoneSelect.appendChild(option);
                });
            },
            error: function (error) {
                console.error("Error loading customer phones:", error);
            }
        });
    }

    $("#phone").change(function () {
        let selectedPhone = $(this).val();
        if (selectedPhone) {
            $.ajax({
                url: `http://localhost:8080/api/v1/customer/getCustomerByPhone/${selectedPhone}`,
                method: "GET",
                dataType: "json",
                success: function (resp) {
                    console.log("Customer Data Response:", resp); // Debugging output

                    if (resp && resp.data) {
                        console.log("Customer Name:", resp.data); // This should log the customer name
                        $("#customerName").val(resp.data);  // Set the customer name directly
                    } else {
                        $("#customerName").val("");  // Clear input if no name found
                    }
                },
                error: function (error) {
                    console.error("Error fetching customer details:", error);
                }
            });
        } else {
            console.log("No phone selected.");
            $("#customerName").val("");  // Clear input if no phone selected
        }
    });

    $("#itemCode").change(function () {
        let selectedCode = $(this).val();
        if (selectedCode) {
            $.ajax({
                url: `http://localhost:8080/api/v1/item/getItemByCode/${selectedCode}`, // API to get item details by code
                method: "GET",
                dataType: "json",
                success: function (resp) {
                    console.log("Item Data Response:", resp); // Debugging output
                    if (resp && resp.data) {
                        // Assuming the response contains item details like name, quantity, and price
                        $("#itemName").val(resp.data.name); // Fill in item name
                        $("#availableQty").val(resp.data.quantity); // Fill in available quantity
                        $("#unitPrice").val(resp.data.price); // Fill in unit price
                    } else {
                        // Clear fields if no item found
                        $("#itemName").val("");
                        $("#availableQty").val("");
                        $("#unitPrice").val("");
                    }
                },
                error: function (error) {
                    console.error("Error fetching item details:", error);
                }
            });
        } else {
            // Clear fields if no item code selected
            $("#itemName").val("");
            $("#availableQty").val("");
            $("#unitPrice").val("");
        }
    });

    let cart = [];

    $("#quantity").on("input", function () {
        let qty = parseInt($(this).val()) || 0;
        let price = parseFloat($("#unitPrice").val()) || 0;
        $("#total").val(qty * price);
    });

    $("#addToCart").click(function () {
        let itemCode = $("#itemCode").val();
        let itemName = $("#itemName").val();
        let availableQty = parseInt($("#availableQty").val()) || 0;
        let quantity = parseInt($("#quantity").val()) || 0;
        let unitPrice = parseFloat($("#unitPrice").val()) || 0;
        let total = quantity * unitPrice;

        if (!itemCode || !quantity || quantity > availableQty) {
            alert("Invalid quantity or item selection!");
            return;
        }

        let existingItem = cart.find(item => item.itemCode === itemCode);
        if (existingItem) {
            existingItem.quantity += quantity;
            existingItem.total += total;
        } else {
            cart.push({ itemCode, itemName, quantity, unitPrice, total });
        }

        updateCartTable();
        $("#quantity").val("");
        $("#total").val("");
    });

    function updateCartTable() {
        let tbody = $("#cartTableBody");
        tbody.empty();

        cart.forEach((item, index) => {
            tbody.append(`
            <tr>
                <td>${item.itemCode}</td>
                <td>${item.itemName}</td>
                <td>${item.quantity}</td>
                <td>${item.total.toFixed(2)}</td>
                <td><button class="btn btn-danger btn-sm" onclick="removeCartItem(${index})">Remove</button></td>
            </tr>
        `);
        });
    }

    function removeCartItem(index) {
        cart.splice(index, 1);
        updateCartTable();
    }

    // $("#placeOrder").click(function () {
    //     if (cart.length === 0) {
    //         alert("Cart is empty!");
    //         return;
    //     }
    //
    //     let orderData = {
    //         orderId: $("#orderId").val(),
    //         orderDate: $("#orderDate").val(),
    //         phone: $("#phone").val(),
    //         items: cart
    //     };
    //
    //     $.ajax({
    //         url: "http://localhost:8080/api/v1/order/save",
    //         method: "POST",
    //         contentType: "application/json",
    //         data: JSON.stringify(orderData),
    //         success: function (resp) {
    //             alert("Order placed successfully!");
    //             cart = [];
    //             updateCartTable();
    //             $("#orderForm")[0].reset();
    //         },
    //         error: function (error) {
    //             console.error("Error placing order:", error);
    //             alert("Failed to place order!");
    //         }
    //     });
    // });

    $("#placeOrder").click(function () {
        if (cart.length === 0) {
            alert("Cart is empty!");
            return;
        }

        let orderData = {
            orderId: $("#orderId").val(),
            orderDate: $("#orderDate").val(),
            phone: $("#phone").val(),
            items: cart
        };

        console.log("Order Data before sending:", orderData); // Debugging

        $.ajax({
            url: "http://localhost:8080/api/v1/order/save",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(orderData),
            success: function (resp) {
                console.log("Server Response:", resp); // Debugging
                alert("Order placed successfully!");
                cart = [];
                updateCartTable();
                $("#orderForm")[0].reset();
            },
            error: function (error) {
                console.error("Error placing order:", error);
                alert("Failed to place order!");
            }
        });
    });


</script>
</body>
</html>
